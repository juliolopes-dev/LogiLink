# üìã CONTEXTO DO PROJETO - LogiLink

## √öltima Sess√£o: 06/Fevereiro/2026

---

## ‚úÖ O que foi feito nesta sess√£o

### 1. Filial de Origem no Banco (Pedido_DRP)
- Adicionadas colunas `cod_filial_origem` e `nome_filial_origem` na tabela `Pedido_DRP`
- Script de migra√ß√£o: `backend/scripts/adicionar-filial-origem-pedido-drp.ts`
- 29 registros existentes atualizados com CD (04) como padr√£o
- INSERTs atualizados nos dois endpoints (DRP por NF e DRP por Produto)

### 2. Gera√ß√£o de Pedidos ‚Äî Todos os Produtos
- **Bug corrigido:** Frontend enviava apenas os produtos da p√°gina atual ao gerar pedidos
- **Corre√ß√£o:** Agora envia `todosProdutos` (todos os itens calculados)

### 3. Lotes de 30 SKUs por Pedido
- Pedidos DRP por Produto agora s√£o divididos em lotes de **30 SKUs** por filial
- Exemplo: Petrolina com 80 itens ‚Üí 3 pedidos (30 + 30 + 20)

### 4. Webhook Resumido
- Antes: 1 disparo por pedido com delay de 2 segundos entre cada
- Agora: **1 √∫nico disparo** com lista resumida de todos os pedidos gerados
- Campos: `total_pedidos` + array `pedidos` (numero_pedido, cod_filial, nome_filial, total_itens, total_quantidade)

### 5. Estoque M√≠nimo Din√¢mico no DRP por Produto
- **Antes:** DRP por Produto usava apenas tabela antiga `Estoque_DRP.estoque_minimo`
- **Agora:** Usa fun√ß√£o compartilhada `buscarEstoqueMinimoAtualizado`:
  - 1¬∫ ‚Üí tabela `estoque_minimo` (c√°lculo autom√°tico ABC + tend√™ncia + sazonalidade)
  - 2¬∫ ‚Üí tabela `Estoque_DRP` (fallback)
- Fun√ß√£o extra√≠da para `backend/src/utils/drp/estoque-minimo.ts` (compartilhada entre DRP NF e DRP Produto)

### 6. Prote√ß√£o da Filial de Origem
- **CD (04):** Distribui todo o estoque (sem prote√ß√£o)
- **Outras filiais:** Reserva o estoque m√≠nimo din√¢mico antes de distribuir
- Exemplo: Petrolina com 50 de estoque e 20 de est. m√≠nimo ‚Üí distribui apenas 30

---

## üìÅ Arquivos Alterados

| Arquivo | Altera√ß√£o |
|---------|-----------|
| `backend/scripts/adicionar-filial-origem-pedido-drp.ts` | **NOVO** ‚Äî Script migra√ß√£o colunas filial origem |
| `backend/src/utils/drp/estoque-minimo.ts` | **NOVO** ‚Äî Fun√ß√£o compartilhada estoque m√≠nimo din√¢mico |
| `backend/src/utils/drp/index.ts` | Export da nova fun√ß√£o |
| `backend/src/utils/webhook-pedido.ts` | Webhook resumido (1 disparo com lista de pedidos) |
| `backend/src/services/drp/produto.service.ts` | Estoque m√≠nimo din√¢mico + prote√ß√£o filial origem |
| `backend/src/routes/drp/produto.routes.ts` | Lotes 30 SKUs + filial origem no INSERT |
| `backend/src/routes/nf-entrada.ts` | Import fun√ß√£o compartilhada + filial origem no INSERT |
| `frontend/src/pages/AnaliseDRP.tsx` | Enviar todosProdutos ao gerar pedidos |
| `docs/DRP/CALCULO_DRP_PRODUTO.md` | Documenta√ß√£o atualizada |
| `docs/ESTOQUE_MINIMO.md` | Documenta√ß√£o atualizada |

---

### 7. Corre√ß√µes de Bugs
- **Coluna `manual` inexistente** ‚Üí corrigido para `metodo = 'automatico'` na query de estoque m√≠nimo
- **Payload Too Large** ‚Üí `bodyLimit` aumentado para 50MB na rota `/api/drp/gerar-pedidos`

---

## üß™ O que foi testado
- Script de migra√ß√£o executado com sucesso (29 registros atualizados)
- Commits e push realizados sem erros
- Deploy e teste de gera√ß√£o de pedidos

## ‚è≠Ô∏è Pr√≥ximos Passos
- Verificar se webhook resumido chega corretamente no n8n
- Testar prote√ß√£o da filial de origem selecionando uma filial diferente do CD
- Testar estoque m√≠nimo din√¢mico comparando valores com o sistema antigo

---

## üîó URLs Importantes
- **Webhook n8n:** `https://n8n-n8n.tbs25p.easypanel.host/webhook/197fdaf9-a28c-4e34-ba63-1fd37a79523b`
